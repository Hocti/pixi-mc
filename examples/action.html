<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="/node_modules/pixi.js/dist/browser/pixi.min.js"></script>
	<script src="/node_modules/pixi-filters/dist/pixi-filters.js"></script>
	<script src="/node_modules/@pixi/sound/dist/pixi-sound.js"></script>
	<script src="../dist/pixi-mc.js"></script>
</head>
<body>
	<canvas id="maincanvas"></canvas>
	<div id="box">
		<div id="text"></div>
		<input type="range" max="1" min="1" id='input_f'><br/>
		<input type="button" value="play">
		<input type="button" value="stop">
		<input type="button" value="prev">
		<input type="button" value="next">
		<input type="button" value="first_frame">

		<input type="button" value="prev_action">
		<input type="button" value="next_action">
		<br/>
		<input type="text" id="fps_ip" value="10"><input type="button" value="fps">
		<br/>
		<table id='catable'>
			<tr>
				<td>contrast</td>
				<td><input type="range" value='0' step ="10" max="100" min="-100" id='input_contrast'></td>
				<td class='v'></td>
			</tr>
			<tr>
				<td>hue</td>
				<td><input type="range" step ="10" max="180" min="-180" id='input_hue'></td>
				<td class='v'></td>
			</tr>
			<tr>
				<td>saturation</td>
				<td><input type="range" step ="10" max="100" min="-100" id='input_saturation'></td>
				<td class='v'></td>
			</tr>
			<tr>
				<td>brightness</td>
				<td><input type="range" step ="0.1" max="1" min="-1" id='input_brightness'></td>
				<td class='v'></td>
			</tr>
		</table>
		<table id='colortable'>
			<tr>
				<td>color</td>
				<td><input type="color" id="favcolor" value="#ff0000"></td>
				<td><input type="range" step ="0.1" max="1" min="0" id='input_color_p'></td>
			</tr>
		</table>
		<td><input type="color" id="color2" value="#ff0000"></td>
		
	</div>
	<style>
		html,body{
			margin: 0;padding: 0;
			position: relative;
			background-color: #ddd;
		}
		#box,#maincanvas{
			position: absolute;
		}
		#maincanvas{
			top: 0;
		}
		#box{
			top: 600px;
			color: red;
		}
		#input_f{
			width: 450px;
		}
		input[type="text"]{
			width: 50px;
		}
	</style>
	<script>
		PIXI.utils.skipHello();
		var mcrect = new PIXI.Rectangle(0, 0, 600, 600);

		var app = new PIXI.Application({
			view: document.getElementById('maincanvas'),
			width: mcrect.width,
			height: mcrect.height,
			backgroundColor: 0x000000,
			transparent: true
		});


		PIXIMC.MCPlayer.initTicker(app.ticker);
		PIXIMC.MCPlayer.getInstance().fps = 60;

        let currMC,man_action,man_attack;
        const mc_list=['man_alt','man_attack','man_action'];

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        (async()=>{



            const re=await PIXIMC.FileList.getfolderInfoFromTextAsync('media/files.txt','media/')
            await PIXIMC.MCLoader.loadModelsAsync(mc_list,'media/')
            //console.log('loaded files',re)
            
            //.symbolList['alt_part/hair']
            let man_alt = PIXIMC.MCLibrary.get('media/man_alt/').makeInstance();
            man_alt.x=200;
            man_alt.y=150;
            //app.stage.addChild(man_alt);

            
            man_attack = new PIXIMC.MCEX(PIXIMC.MCLibrary.getSymbol('media/man_attack/'))
            man_attack.x=100;
            man_attack.y=200;
            man_attack.timeline.gotoAndStop(13)
			
			const hairE=PIXIMC.EffectGroupAction.create();
			hairE.alpha=0.5
			hairE.blendMode=7

			const hairEE=PIXIMC.EffectGroupAction.create();
			const cc=new PIXIMC.ColorChange();
			cc.brightness=0.5
			hairE.colorMatrix=cc.colorMatrix;

			PIXIMC.MCLibrary.getSymbol('media/man_alt/','alt_part/face').defaultMatrix=PIXIMC.TMath.makeMatrix(1/2.2,undefined,0,-1,-0.5)
			/*
			PIXIMC.MCReplacer.addDefaultRule({
					type:'symbol',
					target:'self',
				matchType:'name',
				matchModelKey:'media/man_alt/',
				matchKey:'alt_part/face',
				replaceMatrix:PIXIMC.TMath.makeMatrix(1/2.2,undefined,0,-1,-0.5)
			})
			*/

			PIXIMC.MCReplacer.addDefaultRule({
				matchType:'name',
				matchModelKey:'media/man_alt/',
				matchKey:'alt_part/hair*',
				replaceMatrix:PIXIMC.TMath.makeMatrix(1,1.5)
			})

			man_attack.replacer.addRules([
			{
				target:'self',
				type:'symbol',
				matchType:'name',
				matchKey:'man_part/chest',
				replaceSymbol:PIXIMC.MCLibrary.getSymbol('media/man_action/','man_part/chest')
			},{
				target:'child',
				matchType:'name',
				matchKey:'man_part/*',
				type:'symbol',

				replaceModel:PIXIMC.MCLibrary.get('media/man_alt/'),
				replaceKey:'alt_part/*'
			},{
				target:'both',
				matchType:'name',
				matchKey:'left_*',
				type:'layer',
				effect:hairE
			},{
				target:'both',
				matchType:'name',
				matchKey:'man_part/right_fist',
				type:'symbol',
				replaceKey:'man_part/head'
			}])
			/*
			*/	

            app.stage.addChild(man_attack);


            man_action = PIXIMC.MCLibrary.get('media/man_action/').makeInstance();
            man_action.x=300;
            man_action.y=250;
            app.stage.addChild(man_action);
            man_action.timeline.stop();
			man_action.timeline.gotoAndStop(8)
			/*
            setTimeout(()=>{
                const arm=app.stage.children[1].children[1]
                console.log(arm.x,arm.y)
            },1000)
			*/
            
            currMC=man_action

			const atr=new PIXIMC.MCActor();

			
			atr.replacer.addRules([{
				target:'child',
				type:'symbol',
				matchType:'name',
				matchKey:'man_part/*',
				replaceKey:'man_part/*',
				matchModelKey:'media/man_attack/',
				replaceModel:PIXIMC.MCLibrary.get('media/man_action/'),
			},
			{
				target:'child',
				type:'symbol',
				matchType:'name',
				matchKey:'man_part/chest',
				//matchModelKey:'media/man_action/',
				replaceSymbol:PIXIMC.MCLibrary.getSymbol('media/man_attack/','man_part/chest')
			},{
				target:'child',
				matchType:'name',
				matchKey:'man_part/*',
				type:'symbol',

				replaceModel:PIXIMC.MCLibrary.get('media/man_alt/'),
				replaceKey:'alt_part/*'
			},{
				target:'both',
				matchType:'name',
				matchKey:'left_*',
				type:'layer',
				effect:hairE
			}])

			const atka=atr.addModel(PIXIMC.MCLibrary.getSymbol('media/man_attack/'))
			atr.addModel(PIXIMC.MCLibrary.getSymbol('media/man_action/'))

			atka.replacer.addRules([{
				target:'both',
				matchType:'name',
				matchKey:'man_part/right_fist',
				type:'symbol',
				replaceKey:'man_part/head'
			}])


			atr.x=100;
			atr.y=400;
			atr.showAction('punch','hold',0.5);
			app.stage.addChild(atr)


            currMC=atr
			
        })()
		
        /*
		PIXIMC.FileList.getfolderInfoFromText('media/files.txt','media/', async function (_data) {
            console.log('loaded files2',_data)

            /*
            const mcModelList={};
            for(let k of mc_list){
                const folderInf=PIXIMC.FileList.getInstance().getFolderInfoFromPath('media/'+k)
                mcModelList[k]=await PIXIMC.MCLoader.loadModelAsync(folderInf)
            }
            console.log('all done',mcModelList)


            const mcModelList= await PIXIMC.MCLoader.loadModelsAsync(mc_list,'media/')
            console.log('all done?',mcModelList)


            const mcModelList= await PIXIMC.MCLoader.loadModels(mc_list,'media/',(results)=>{
                console.log('all done',results)
            })

            await PIXIMC.MCLoader.loadModelsAsync(mc_list,'media/')
            
            

		});
*/


		//player
		window.onkeydown = function (e) {
			if (e.key == ".") {
				currMC.timeline.nextFrame();
			}
			else if (e.key == ",") {
				currMC.timeline.prevFrame();
			}
		};
		var whendown = false;
		$("#input_f").change(function (e) {
			currMC.timeline.goto(Number($(this).val()));
		});
		$("#input_f").mousedown(function (e) {
			currMC.timeline.isPlaying;
			currMC.timeline.stop();
		});
		$("#input_f").mouseup(function (e) {
			if (whendown) {
				currMC.timeline.play();
			}
		});
		$("input[value=fps]").click(function (e) {
			PIXIMC.MCPlayer.getInstance().fps = Number($("#fps_ip").val());
		});
		$("input[value=goto]").click(function (e) {
			currMC.timeline.goto($("#jump_ip").val());
		});
		$("input[value=play]").click(function (e) {
			currMC.timeline.play();
		});
		$("input[value=stop]").click(function (e) {
			currMC.timeline.stop();
		});
		$("input[value=next]").click(function (e) {
			currMC.timeline.nextFrame();
		});
		$("input[value=prev]").click(function (e) {
			currMC.timeline.prevFrame();
		});
		$("input[value=first_frame]").click(function (e) {
			currMC.timeline.goto(1);
		});
		$("input[value=next_scene]").click(function (e) {
			currMC.nextScene();
		});
		$("input[value=prev_scene]").click(function (e) {
			currMC.prevScene();
		});
		$("input[value=stopAllSound]").click(function (e) {
			PIXIMC.TSound.stopAllSE();
		});

		//color change
		$("#catable input").change(function (e) {
			let m=PIXIMC.ColorMatrixAction.create();
			$("#catable input").each((k,e)=>{
				let n=$(e).attr('id').substr(6);
				let v=Number($(e).val())
				$(e).parent().parent().find('.v').html(v)

				let newMatrix=PIXIMC.ColorMatrixAction[n](v);

				m=PIXIMC.ColorMatrixAction.multiply(m,newMatrix)
			})
			PIXIMC.MCEffect.setColorMatrix(currMC,m)
			
		});
		
		$("#colortable input").change(function (e) {
			let c=$("#favcolor").val();
			let p=Number($("#input_color_p").val())
			let m=PIXIMC.ColorMatrixAction.tint(c,p)
			PIXIMC.MCEffect.setColorMatrix(currMC,m)
		});
		$("#color2").change(function (e) {
			let c=$("#color2").val();
			let m=PIXIMC.ColorMatrixAction.tintOver(c)
			PIXIMC.MCEffect.setColorMatrix(currMC,m)
		});

	</script>
</body>
</html>